// scripts/fix-imoveis-status.ts
// Este script atualiza todos os imÃ³veis existentes para terem status correto

import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function main() {
  console.log('ðŸ”§ Iniciando correÃ§Ã£o de status dos imÃ³veis...\n')

  try {
    // 1. Buscar todos os imÃ³veis
    const todosImoveis = await prisma.imovel.findMany()
    console.log(`ðŸ“Š Total de imÃ³veis encontrados: ${todosImoveis.length}`)

    if (todosImoveis.length === 0) {
      console.log('â„¹ï¸  Nenhum imÃ³vel para atualizar.')
      return
    }

    // 2. Atualizar imÃ³veis que nÃ£o tÃªm status ou tÃªm status nulo
    const imoveisSemStatus = todosImoveis.filter(i => !i.status || i.status === null)
    console.log(`ðŸ” ImÃ³veis sem status: ${imoveisSemStatus.length}`)

    if (imoveisSemStatus.length > 0) {
      // Define status baseado no campo 'disponivel'
      for (const imovel of imoveisSemStatus) {
        const novoStatus = imovel.disponivel ? 'ATIVO' : 'ARQUIVADO'
        
        await prisma.imovel.update({
          where: { id: imovel.id },
          data: { 
            status: novoStatus,
            disponivel: novoStatus === 'ATIVO' // Garante consistÃªncia
          }
        })

        console.log(`  âœ… ImÃ³vel ${imovel.id.substring(0, 8)} â†’ ${novoStatus}`)
      }
    }

    // 3. Sincronizar campo 'disponivel' com 'status' para todos
    console.log('\nðŸ”„ Sincronizando campo "disponivel" com "status"...')
    
    const imoveisParaSincronizar = await prisma.imovel.findMany({
      where: {
        OR: [
          { status: 'ATIVO', disponivel: false },
          { status: { not: 'ATIVO' }, disponivel: true }
        ]
      }
    })

    console.log(`ðŸ” ImÃ³veis com inconsistÃªncia: ${imoveisParaSincronizar.length}`)

    for (const imovel of imoveisParaSincronizar) {
      const disponivelCorreto = imovel.status === 'ATIVO'
      
      await prisma.imovel.update({
        where: { id: imovel.id },
        data: { disponivel: disponivelCorreto }
      })

      console.log(`  âœ… ImÃ³vel ${imovel.id.substring(0, 8)} â†’ disponivel: ${disponivelCorreto}`)
    }

    // 4. Resumo final
    console.log('\nðŸ“Š RESUMO FINAL:')
    
    const resumo = await prisma.imovel.groupBy({
      by: ['status'],
      _count: true
    })

    resumo.forEach(r => {
      console.log(`  â€¢ ${r.status}: ${r._count} imÃ³veis`)
    })

    // 5. Registrar na auditoria
    await prisma.auditoria.create({
      data: {
        acao: 'MIGRACAO_STATUS_IMOVEIS',
        tabela: 'Imovel',
        usuario: 'sistema',
        dados: JSON.stringify({
          totalAtualizado: imoveisSemStatus.length + imoveisParaSincronizar.length,
          resumo: resumo
        })
      }
    })

    console.log('\nâœ… MigraÃ§Ã£o concluÃ­da com sucesso!')

  } catch (error) {
    console.error('âŒ Erro durante a migraÃ§Ã£o:', error)
    throw error
  }
}

main()
  .catch((e) => {
    console.error(e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })