generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Lead {
  id              String      @id @default(uuid())
  nome            String
  email           String      @unique
  telefone        String
  origem          String
  status          String      @default("frio")
  imovelInteresse String? 
  dataCaptcha     DateTime    @default(now())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // RELACIONAMENTOS STR
  consultas       Consulta[]
  historicos      Historico[] // ✅ Adicionado para Linha do Tempo

  @@index([email])
  @@index([status])
  @@index([origem])
  @@map("leads")
}

// ✅ NOVO MODEL: HISTÓRICO DE ATENDIMENTO (STR GENETICS)
model Historico {
  id        String   @id @default(uuid())
  detalhes  String   @db.Text
  tipo      String   // WHATSAPP, LIGACAO, VISITA, PROPOSTA, EMAIL
  data      DateTime @default(now())
  
  // Relacionamento com Lead
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([data])
  @@map("historicos_atendimento")
}

model Imovel {
  id             String       @id @default(uuid())
  tipo           String
  endereco       String
  cidade         String
  estado         String
  preco          Decimal      @db.Decimal(12, 2)
  metragem       Decimal      @db.Decimal(10, 2)
  quartos        Int          @default(0)
  banheiros      Int          @default(0)
  vagas          Int          @default(0)
  descricao      String?
  disponivel     Boolean      @default(true)
  proprietarioId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  imagens        String[]     @default([])
  status         String       @default("ATIVO")
  
  consultas      Consulta[]
  proprietario   Proprietario @relation(fields: [proprietarioId], references: [id], onDelete: Cascade)

  @@index([cidade])
  @@index([estado])
  @@index([disponivel])
  @@index([tipo])
  @@index([status])
  @@index([proprietarioId])
  @@map("imoveis")
}

model Proprietario {
  id        String   @id @default(uuid())
  nome      String
  telefone  String
  email     String   @unique
  cpf       String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  imoveis   Imovel[]

  @@index([email])
  @@index([cpf])
  @@map("proprietarios")
}

model Consulta {
  id                 String    @id @default(uuid())
  leadId             String
  imovelId           String
  data               DateTime  @default(now())
  resultado          String?
  tipo               String    @default("visita")
  status             String    @default("agendada")
  observacoes        String?
  comissao           Decimal?  @db.Decimal(10, 2)
  createdAt          DateTime  @default(now())
  dataFechamento     DateTime?
  motivoCancelamento String?
  updatedAt          DateTime  @updatedAt
  valorProposta      Decimal?  @db.Decimal(12, 2)
  
  imovel             Imovel    @relation(fields: [imovelId], references: [id], onDelete: Cascade)
  lead               Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([data])
  @@index([status])
  @@index([leadId])
  @@index([imovelId])
  @@map("consultas")
}

model AnaliseMercado {
  id          String      @id @default(uuid())
  cidade      String
  estado      String      @default("SP")
  valorM2     Decimal     @db.Decimal(10, 2)
  valorMinimo Decimal?    @db.Decimal(12, 2)
  valorMaximo Decimal?    @db.Decimal(12, 2)
  dataAnalise DateTime    @default(now())
  fonte       String
  tendencia   String?
  observacoes String?
  relatorios  Relatorio[]

  @@index([cidade])
  @@index([estado])
  @@index([dataAnalise])
  @@map("analises_mercado")
}

model Relatorio {
  id          String          @id @default(uuid())
  titulo      String
  tipo        String
  conteudo    String
  dataGeracao DateTime        @default(now())
  periodo     String?
  geradoPor   String?
  analiseId   String?
  analise     AnaliseMercado? @relation(fields: [analiseId], references: [id])

  @@index([tipo])
  @@index([dataGeracao])
  @@index([analiseId])
  @@map("relatorios")
}

model Auditoria {
  id         String   @id @default(uuid())
  acao       String
  tabela     String
  registroId String?
  usuario    String   @default("sistema")
  dados      String?
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([acao])
  @@index([tabela])
  @@index([usuario])
  @@index([createdAt])
  @@map("auditorias")
}

model Usuario {
  id        String   @id @default(uuid())
  nome      String
  email     String   @unique
  senha     String
  role      String   @default("usuario")
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
  @@map("usuarios")
}
