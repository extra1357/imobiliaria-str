generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// LEADS E ATENDIMENTO
// ============================================================================

model Lead {
  id              String      @id @default(uuid())
  nome            String
  email           String
  telefone        String
  origem          String      @default("site")
  status          String      @default("novo") // novo, contatado, qualificado, negociando, fechado, perdido
  imovelInteresse String? 
  mensagem        String?     @db.Text
  dataPreferencia String?
  
  corretorId      String?     // Corretor responsável pelo lead
  corretor        Corretor?   @relation(fields: [corretorId], references: [id])
  
  dataCaptcha     DateTime    @default(now())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  consultas       Consulta[]
  historicos      Historico[]
  vendas          Venda[]
  alugueis        Aluguel[]

  @@index([email])
  @@index([status])
  @@index([origem])
  @@index([corretorId])
  @@map("leads")
}

model Historico {
  id        String   @id @default(uuid())
  detalhes  String   @db.Text
  tipo      String   // WHATSAPP, LIGACAO, VISITA, PROPOSTA, EMAIL
  data      DateTime @default(now())
  
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([data])
  @@map("historicos_atendimento")
}

// ============================================================================
// IMÓVEIS E PROPRIETÁRIOS
// ============================================================================

model Imovel {
  id              String       @id @default(uuid())
  codigo          String?      @unique // Código interno do imóvel (ex: APT-001)
  tipo            String       // Apartamento, Casa, Comercial, Terreno
  finalidade      String       @default("venda") // venda, aluguel, ambos
  endereco        String
  bairro          String?
  cidade          String
  estado          String
  cep             String?
  preco           Decimal      @db.Decimal(12, 2)
  precoAluguel    Decimal?     @db.Decimal(10, 2) // Para imóveis de aluguel
  metragem        Decimal      @db.Decimal(10, 2)
  quartos         Int          @default(0)
  suites          Int          @default(0)
  banheiros       Int          @default(0)
  vagas           Int          @default(0)
  descricao       String?      @db.Text
  caracteristicas String[]     @default([]) // piscina, churrasqueira, etc
  disponivel      Boolean      @default(true)
  destaque        Boolean      @default(false)
  
  proprietarioId  String
  proprietario    Proprietario @relation(fields: [proprietarioId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  imagens         String[]     @default([])
  status          String       @default("ATIVO") // ATIVO, INATIVO, VENDIDO, ALUGADO
  
  consultas       Consulta[]
  vendas          Venda[]
  alugueis        Aluguel[]

  @@index([cidade])
  @@index([estado])
  @@index([disponivel])
  @@index([tipo])
  @@index([finalidade])
  @@index([status])
  @@index([proprietarioId])
  @@map("imoveis")
}

model Proprietario {
  id          String   @id @default(uuid())
  nome        String
  telefone    String
  email       String   @unique
  cpfCnpj     String?  @unique
  tipo        String   @default("PF") // PF ou PJ
  endereco    String?
  observacoes String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  imoveis     Imovel[]
  vendas      Venda[]
  alugueis    Aluguel[]

  @@index([email])
  @@index([cpfCnpj])
  @@map("proprietarios")
}

// ============================================================================
// CORRETORES E COMISSÕES
// ============================================================================

model Corretor {
  id              String      @id @default(uuid())
  nome            String
  email           String      @unique
  telefone        String
  cpf             String?     @unique
  creci           String      @unique // Registro obrigatório
  dataAdmissao    DateTime    @default(now())
  dataDemissao    DateTime?
  ativo           Boolean     @default(true)
  
  // Dados bancários para pagamento
  banco           String?
  agencia         String?
  conta           String?
  tipoConta       String?     // corrente, poupanca
  pix             String?
  
  // Comissão padrão do corretor (%)
  comissaoPadrao  Decimal     @default(50) @db.Decimal(5, 2) // 50% da comissão da imobiliária
  
  foto            String?
  observacoes     String?     @db.Text
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  leads           Lead[]
  consultas       Consulta[]
  vendas          Venda[]
  alugueis        Aluguel[]
  comissoes       Comissao[]

  @@index([email])
  @@index([creci])
  @@index([ativo])
  @@map("corretores")
}

model Comissao {
  id              String    @id @default(uuid())
  
  corretorId      String
  corretor        Corretor  @relation(fields: [corretorId], references: [id])
  
  vendaId         String?   
  venda           Venda?    @relation(fields: [vendaId], references: [id])
  
  aluguelId       String?
  aluguel         Aluguel?  @relation(fields: [aluguelId], references: [id])
  
  tipo            String    // VENDA, ALUGUEL, CAPTACAO, BONUS
  valorBase       Decimal   @db.Decimal(12, 2) // Valor da venda/aluguel
  percentual      Decimal   @db.Decimal(5, 2)  // % de comissão
  valorComissao   Decimal   @db.Decimal(10, 2) // Valor calculado
  
  status          String    @default("pendente") // pendente, aprovada, paga, cancelada
  dataPrevista    DateTime? // Data prevista para pagamento
  dataPagamento   DateTime? // Data efetiva do pagamento
  
  observacoes     String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([corretorId])
  @@index([vendaId])
  @@index([aluguelId])
  @@index([status])
  @@index([dataPrevista])
  @@map("comissoes")
}

// ============================================================================
// VENDAS
// ============================================================================

model Venda {
  id                  String    @id @default(uuid())
  
  imovelId            String
  imovel              Imovel    @relation(fields: [imovelId], references: [id])
  
  leadId              String    // Comprador
  lead                Lead      @relation(fields: [leadId], references: [id])
  
  proprietarioId      String    // Vendedor
  proprietario        Proprietario @relation(fields: [proprietarioId], references: [id])
  
  corretorId          String
  corretor            Corretor  @relation(fields: [corretorId], references: [id])
  
  // Valores
  valorVenda          Decimal   @db.Decimal(12, 2)
  valorEntrada        Decimal?  @db.Decimal(12, 2)
  valorFinanciado     Decimal?  @db.Decimal(12, 2)
  
  // Comissão da imobiliária
  percentualComissao  Decimal   @default(6) @db.Decimal(5, 2) // Padrão 6%
  valorComissao       Decimal   @db.Decimal(10, 2)
  
  // Datas importantes
  dataPropostaInicial DateTime  @default(now())
  dataAssinatura      DateTime?
  dataEscritura       DateTime?
  dataRegistro        DateTime?
  
  // Status e documentação
  status              String    @default("proposta") // proposta, documentacao, assinatura, registro, concluida, cancelada
  formaPagamento      String?   // avista, financiamento, parcelado
  bancoFinanciamento  String?
  
  observacoes         String?   @db.Text
  documentos          String[]  @default([])
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  comissoes           Comissao[]

  @@index([imovelId])
  @@index([leadId])
  @@index([corretorId])
  @@index([status])
  @@index([dataAssinatura])
  @@map("vendas")
}

// ============================================================================
// ALUGUÉIS
// ============================================================================

model Aluguel {
  id                  String    @id @default(uuid())
  
  imovelId            String
  imovel              Imovel    @relation(fields: [imovelId], references: [id])
  
  inquilinoId         String    // Lead que virou inquilino
  inquilino           Lead      @relation(fields: [inquilinoId], references: [id])
  
  proprietarioId      String
  proprietario        Proprietario @relation(fields: [proprietarioId], references: [id])
  
  corretorId          String
  corretor            Corretor  @relation(fields: [corretorId], references: [id])
  
  // Valores
  valorAluguel        Decimal   @db.Decimal(10, 2)
  valorCondominio     Decimal?  @db.Decimal(10, 2)
  valorIPTU           Decimal?  @db.Decimal(10, 2)
  valorTotal          Decimal   @db.Decimal(10, 2) // Soma de tudo
  
  // Garantia
  tipoGarantia        String?   // caucao, fiador, seguro_fianca, titulo_capitalizacao
  valorGarantia       Decimal?  @db.Decimal(10, 2)
  
  // Datas do contrato
  dataInicio          DateTime
  dataFim             DateTime
  diaVencimento       Int       @default(10) // Dia do mês para vencimento
  
  // Reajuste
  indiceReajuste      String    @default("IGPM") // IGPM, IPCA, INPC
  dataProximoReajuste DateTime?
  
  // Taxa administrativa da imobiliária
  taxaAdministracao   Decimal   @default(10) @db.Decimal(5, 2) // Padrão 10%
  
  status              String    @default("ativo") // ativo, encerrado, inadimplente, renovacao
  
  observacoes         String?   @db.Text
  documentos          String[]  @default([])
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  comissoes           Comissao[]
  pagamentos          PagamentoAluguel[]

  @@index([imovelId])
  @@index([inquilinoId])
  @@index([proprietarioId])
  @@index([corretorId])
  @@index([status])
  @@index([dataFim])
  @@map("alugueis")
}

model PagamentoAluguel {
  id              String    @id @default(uuid())
  
  aluguelId       String
  aluguel         Aluguel   @relation(fields: [aluguelId], references: [id], onDelete: Cascade)
  
  competencia     String    // Mês/Ano: "01/2026"
  dataVencimento  DateTime
  dataPagamento   DateTime?
  
  valorAluguel    Decimal   @db.Decimal(10, 2)
  valorCondominio Decimal?  @db.Decimal(10, 2)
  valorIPTU       Decimal?  @db.Decimal(10, 2)
  valorMulta      Decimal?  @db.Decimal(10, 2) // Se pago em atraso
  valorJuros      Decimal?  @db.Decimal(10, 2)
  valorTotal      Decimal   @db.Decimal(10, 2)
  
  status          String    @default("pendente") // pendente, pago, atrasado, cancelado
  formaPagamento  String?   // pix, boleto, transferencia, dinheiro
  comprovante     String?   // URL do comprovante
  
  observacoes     String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([aluguelId])
  @@index([competencia])
  @@index([status])
  @@index([dataVencimento])
  @@map("pagamentos_aluguel")
}

// ============================================================================
// CONSULTAS/VISITAS
// ============================================================================

model Consulta {
  id                  String    @id @default(uuid())
  leadId              String
  imovelId            String
  corretorId          String?
  
  data                DateTime  @default(now())
  dataAgendada        DateTime?
  resultado           String?   // interessado, sem_interesse, pensando, fez_proposta
  tipo                String    @default("visita") // visita, ligacao, video_chamada
  status              String    @default("agendada") // agendada, realizada, cancelada, remarcada
  observacoes         String?   @db.Text
  
  comissao            Decimal?  @db.Decimal(10, 2)
  dataFechamento      DateTime?
  motivoCancelamento  String?
  valorProposta       Decimal?  @db.Decimal(12, 2)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  imovel              Imovel    @relation(fields: [imovelId], references: [id], onDelete: Cascade)
  lead                Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  corretor            Corretor? @relation(fields: [corretorId], references: [id])

  @@index([data])
  @@index([status])
  @@index([leadId])
  @@index([imovelId])
  @@index([corretorId])
  @@map("consultas")
}

// ============================================================================
// ANÁLISE DE MERCADO E RELATÓRIOS
// ============================================================================

model AnaliseMercado {
  id          String      @id @default(uuid())
  cidade      String
  estado      String      @default("SP")
  valorM2     Decimal     @db.Decimal(10, 2)
  valorMinimo Decimal?    @db.Decimal(12, 2)
  valorMaximo Decimal?    @db.Decimal(12, 2)
  dataAnalise DateTime    @default(now())
  fonte       String
  tendencia   String?
  observacoes String?
  relatorios  Relatorio[]

  @@index([cidade])
  @@index([estado])
  @@index([dataAnalise])
  @@map("analises_mercado")
}

model Relatorio {
  id          String          @id @default(uuid())
  titulo      String
  tipo        String
  conteudo    String          @db.Text
  dataGeracao DateTime        @default(now())
  periodo     String?
  geradoPor   String?
  analiseId   String?
  analise     AnaliseMercado? @relation(fields: [analiseId], references: [id])

  @@index([tipo])
  @@index([dataGeracao])
  @@index([analiseId])
  @@map("relatorios")
}

// ============================================================================
// SISTEMA
// ============================================================================

model Auditoria {
  id         String   @id @default(uuid())
  acao       String
  tabela     String
  registroId String?
  usuario    String   @default("sistema")
  dados      String?  @db.Text
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([acao])
  @@index([tabela])
  @@index([usuario])
  @@index([createdAt])
  @@map("auditorias")
}

model Usuario {
  id        String   @id @default(uuid())
  nome      String
  email     String   @unique
  senha     String
  role      String   @default("usuario") // admin, gerente, corretor, usuario
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
  @@map("usuarios")
}
